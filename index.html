<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>詩物遊戲 AI 裁判 (美學升級版)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* CSS 變數定義，方便管理主題色 */
        :root {
            --primary-color: #4A4A6A; /* 深灰藍，更沉穩 */
            --accent-color: #9B59B6; /* 雅緻的紫羅蘭，更具藝術感 */
            --accent-light: #C39BD6;
            --bg-color: #F8F4F9; /* 淺淡的背景色 */
            --card-bg: #FFFFFF;
            --border-color: #E0E0E0;
            --text-color-dark: #333333;
            --text-color-medium: #666666;
            --text-color-light: #AAAAAA;

            --poem-preview-bg: #F0F4F8; /* 詩句預覽區背景，更柔和 */
            --poem-preview-border: #A9CCE3; /* 詩句預覽區邊框 */

            --success-bg: #D4EDDA;
            --success-border: #28A745;
            --success-text: #155724;

            --error-bg: #F8D7DA;
            --error-border: #DC3545;
            --error-text: #721C24;

            --warning-bg: #FFF3CD;
            --warning-border: #FFC107;
            --warning-text: #856404;

            --font-serif: 'Noto Serif TC', serif;
            --font-sans: 'Noto Sans TC', sans-serif;
        }

        /* 全局樣式 */
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            margin: 0;
            padding: 40px 20px; /* 增加上下邊距 */
            color: var(--text-color-dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 容器樣式 */
        .container {
            max-width: 768px; /* 增加最大寬度 */
            margin: 0 auto;
            background: var(--card-bg);
            padding: 40px; /* 增加內邊距 */
            border-radius: 20px; /* 更圓潤的圓角 */
            box-shadow: 0 15px 40px rgba(0,0,0,0.1); /* 更明顯的陰影 */
            animation: fadeIn 0.8s ease-out;
        }

        /* 標題樣式 */
        h1 {
            font-family: var(--font-serif);
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px; /* 增加間距 */
            font-size: 2.5rem; /* 更大標題 */
            letter-spacing: 2px;
            position: relative;
        }
        h1::after {
            content: '';
            display: block;
            width: 80px;
            height: 4px;
            background: var(--accent-color);
            margin: 15px auto 0;
            border-radius: 2px;
        }

        h2, h3 {
            font-family: var(--font-serif);
            color: var(--primary-color);
        }

        /* 狀態列 */
        .status-bar {
            text-align: center;
            font-size: 0.95rem;
            margin-bottom: 30px;
            padding: 10px 15px;
            border-radius: 8px;
            background: #EAEAEA;
            color: var(--text-color-medium);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status-bar span {
            margin-left: 8px;
            font-weight: bold;
        }

        .status-online { color: var(--success-border); }
        .status-offline { color: var(--error-border); }
        .status-loading { color: var(--accent-color); }

        /* 輸入組 */
        .input-group { 
            margin-bottom: 30px; /* 增加組間距 */
        }
        label { 
            display: block; 
            margin-bottom: 10px; 
            font-weight: 500; /* 中等粗細 */
            color: var(--primary-color);
            font-size: 1.05rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px; /* 增加內邊距 */
            border: 1px solid var(--border-color); /* 柔和邊框 */
            border-radius: 10px; /* 更圓潤 */
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #FAFAFA;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(155, 89, 182, 0.2); /* 柔和焦點陰影 */
            outline: none;
            background-color: #FFFFFF;
        }
        textarea {
            min-height: 100px; /* 最小高度 */
            resize: vertical; /* 允許垂直調整大小 */
        }

        /* 詩句預覽區樣式 */
        #poem-preview-box {
            margin-top: 15px;
            padding: 20px 25px; /* 增加內邊距 */
            background-color: var(--poem-preview-bg);
            border-left: 6px solid var(--poem-preview-border); /* 粗邊框 */
            border-radius: 10px;
            display: none;
            animation: slideDown 0.4s ease-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); /* 輕微陰影 */
        }
        #poem-preview-box.error {
            background-color: var(--error-bg);
            border-left-color: var(--error-border);
            color: var(--error-text);
        }
        .poem-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* 頂部對齊 */
            margin-bottom: 10px;
        }
        .poem-text {
            font-family: var(--font-serif); /* 詩句用襯線字體 */
            font-size: 1.3rem; /* 更大字體 */
            font-weight: 700; /* 更粗 */
            color: var(--primary-color);
            flex-grow: 1; /* 佔據剩餘空間 */
            line-height: 1.5;
        }
        .poem-source {
            font-size: 0.9rem;
            color: var(--text-color-medium);
            text-align: right;
            margin-top: 5px;
        }

        /* 按鈕樣式 */
        button {
            width: 100%;
            padding: 16px; /* 增加內邊距 */
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 10px; /* 更圓潤 */
            font-size: 1.15rem; /* 更大字體 */
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.3);
        }
        button:hover { 
            background-color: #8E44AD; /* 更深的紫色 */
            transform: translateY(-2px); /* 輕微上浮 */
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(155, 89, 182, 0.3);
        }
        button:disabled { 
            background-color: #CCCCCC; 
            cursor: not-allowed;
            box-shadow: none;
            transform: translateY(0);
        }

        /* [新增] 遊戲結束按鈕的額外樣式，與提交按鈕區隔 */
        #gameEndBtn {
            margin-top: 20px;
            background-color: var(--primary-color); /* 換一個沉穩的主題色 */
            box-shadow: 0 5px 15px rgba(74, 74, 106, 0.3);
        }
        #gameEndBtn:hover {
            background-color: #383857;
            transform: translateY(-2px);
        }

        /* [新增] 8 玩家輸入的容器樣式 */
        .player-inputs-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 兩列佈局：左邊名字，右邊手牌數 */
            gap: 15px 10px;
            margin-bottom: 25px;
            padding-right: 10px; /* 避免靠近邊緣 */
            max-height: 50vh; /* 限制高度，使其可滾動 */
            overflow-y: auto;
        }
        .player-inputs-grid .input-group {
            margin-bottom: 0; /* 移除 input-group 原有的下邊距，讓網格控制間距 */
        }

        /* [新增] 恭喜視窗的樣式 */
        .congratulations-content {
            padding: 50px 30px;
            text-align: center;
        }
        .congratulations-content h3 {
            color: var(--success-border);
            font-size: 2.2rem;
            margin-bottom: 20px;
        }
        .congratulations-content p {
            font-size: 1.2rem;
            color: var(--text-color-dark);
            font-family: var(--font-serif);
        }
        .congratulations-content button {
            margin-top: 20px;
            width: auto;
            min-width: 150px;
        }
        /* [新增] 排名列表樣式 */
        #rankingList {
            list-style: none;
            padding: 0;
            margin: 20px 0 30px;
            text-align: left;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        #rankingList li {
            background-color: var(--poem-preview-bg); /* 柔和的背景色 */
            margin-bottom: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* 針對第一名進行突出顯示 */
        #rankingList li:first-child {
            background-color: var(--accent-light);
            font-weight: bold;
            color: var(--text-color-dark);
            border: 2px solid var(--accent-color);
        }
        #rankingList li .rank-number {
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            color: var(--primary-color);
            margin-right: 15px;
            min-width: 25px;
        }
        #rankingList li .cards-count {
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 500;
            color: var(--accent-color);
        }
        
        /* [新增] 煙花效果容器 (使用 fixed 定位在最上層) */
        .fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* 讓點擊穿透 */
            z-index: 1001; /* 比 modal 高 */
            overflow: hidden;
        }
        
        /* [新增] 煙花/星星的基礎樣式 */
        .star {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
        }

        /* [新增] 響應式調整，在小螢幕上將 8 玩家輸入變成單列 */
        @media (max-width: 480px) {
            .player-inputs-grid {
                grid-template-columns: 1fr; 
                max-height: 60vh; /* 調整滾動高度 */
            }
        }


        .small-btn {
            padding: 10px 20px;
            font-size: 0.95rem;
            width: auto;
            margin-top: 15px; /* 增加與上方元素的間距 */
            display: inline-block; /* 讓按鈕並排或行內顯示 */
            box-shadow: none; /* 小按鈕不需要陰影 */
            background-color: var(--accent-light);
            color: var(--primary-color);
            font-weight: 500;
        }
        .small-btn:hover {
            background-color: var(--accent-color);
            color: white;
            transform: translateY(-1px);
        }

        /* 結果區域 */
        .result-box {
            margin-top: 30px;
            padding: 25px;
            border-radius: 15px;
            display: none;
            animation: fadeIn 0.6s ease-out;
            text-align: center;
        }
        .result-box h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        .result-box p {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        .result-box #resScore {
            font-size: 2.2em; /* 更大的分數 */
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        .result-box #resComment {
            font-family: var(--font-serif); /* 評語用襯線字體 */
            font-size: 1.15rem;
            color: var(--text-color-dark);
            margin-bottom: 20px;
            padding: 0 15px;
        }
        .result-box #resSource {
            font-size: 0.85rem;
            color: var(--text-color-medium);
            display: block;
            margin-top: 15px;
        }

        .pass { background-color: var(--success-bg); border: 1px solid var(--success-border); color: var(--success-text); }
        .pass h2 { color: var(--success-border); }
        .fail { background-color: var(--error-bg); border: 1px solid var(--error-border); color: var(--error-text); }
        .fail h2 { color: var(--error-border); }

        /* 日誌區 */
        #infoLog, #errorLog {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            display: none;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid transparent;
        }
        #infoLog {
            background: var(--success-bg);
            color: var(--success-text);
            border-color: var(--success-border);
        }
        #errorLog {
            background: var(--error-bg);
            color: var(--error-text);
            border-color: var(--error-border);
        }

        /* 設定區 */
        .settings {
            background: var(--warning-bg);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid var(--warning-border);
        }
        .settings label {
            color: var(--warning-text);
        }

        .model-info {
            font-size: 0.8rem;
            color: var(--text-color-medium);
            margin-top: 8px;
            padding-left: 5px;
        }

        /* 詞解按鈕 */
        .explain-btn {
            padding: 8px 18px; /* 調整內邊距 */
            font-size: 0.9rem;
            background-color: #FFC107; /* 鮮明的黃色 */
            color: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            width: auto !important; 
            margin-left: 15px; /* 增加與詩句的間距 */
            flex-shrink: 0; /* 不讓按鈕壓縮 */
            box-shadow: 0 2px 5px rgba(255,193,7,0.3);
            font-weight: 600;
        }
        .explain-btn:hover { 
            background-color: #FFA000; /* 更深的黃色 */
            transform: translateY(-1px);
        }

        /* 彈出視窗樣式 (Modal) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* 更深的半透明背景 */
            backdrop-filter: blur(5px); /* 更明顯的模糊效果 */
            display: none; /* 使用 Flexbox 居中 */
            align-items: center;
            justify-content: center;
            animation: fadeInModal 0.3s ease-out;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto; /* Flexbox 居中 */
            padding: 30px; /* 增加內邊距 */
            border-radius: 15px; /* 更圓潤 */
            width: 90%;
            max-width: 600px; /* 增加最大寬度 */
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            animation: modalSlideIn 0.4s ease-out forwards; /* 彈入動畫 */
            position: relative;
        }

        .modal-content h3 {
            font-family: var(--font-serif);
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .modal-content hr {
            border: none;
            border-top: 1px dashed var(--border-color); /* 虛線分隔線 */
            margin: 20px 0;
        }

        .modal-content #modalPoem {
            font-family: var(--font-serif);
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 15px;
        }

        .modal-content #modalExplanation {
            line-height: 1.8; /* 增加行高 */
            font-size: 1rem;
            color: var(--text-color-dark);
            text-align: justify; /* 文字兩端對齊 */
            max-height: 40vh; /* 限制高度，可滾動 */
            overflow-y: auto;
            padding-right: 10px; /* 為滾動條留出空間 */
        }
        /* 美化滾動條 */
        .modal-content #modalExplanation::-webkit-scrollbar {
            width: 6px;
        }
        .modal-content #modalExplanation::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .modal-content #modalExplanation::-webkit-scrollbar-thumb {
            background: var(--accent-light);
            border-radius: 3px;
        }
        .modal-content #modalExplanation::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        .close-btn {
            color: var(--text-color-light);
            position: absolute; /* 絕對定位 */
            top: 15px;
            right: 20px;
            font-size: 32px; /* 更大 */
            font-weight: normal; /* 正常字重 */
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: var(--primary-color);
        }

        /* 動畫效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
                border-radius: 15px;
                margin: 20px auto;
            }
            h1 {
                font-size: 2rem;
            }
            .poem-text {
                font-size: 1.15rem;
            }
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 25px;
            }
            .modal-content h3 {
                font-size: 1.5rem;
            }
            .modal-content #modalPoem {
                font-size: 1.1rem;
            }
            .close-btn {
                font-size: 28px;
                top: 10px;
                right: 15px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            .container {
                padding: 20px 15px;
                border-radius: 10px;
            }
            h1 {
                font-size: 1.8rem;
                margin-bottom: 15px;
            }
            h1::after {
                width: 60px;
                height: 3px;
                margin-top: 10px;
            }
            .status-bar {
                font-size: 0.85rem;
                padding: 8px;
                margin-bottom: 20px;
            }
            label {
                font-size: 0.95rem;
                margin-bottom: 8px;
            }
            input, select, textarea {
                padding: 10px;
                font-size: 0.9rem;
            }
            button {
                padding: 14px;
                font-size: 1rem;
            }
            .small-btn {
                padding: 8px 15px;
                font-size: 0.8rem;
                margin-top: 10px;
            }
            #poem-preview-box {
                padding: 15px;
                border-left-width: 4px;
            }
            .poem-header {
                flex-direction: column; /* 小螢幕下按鈕換行 */
                align-items: flex-start;
            }
            .poem-text {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            .explain-btn {
                margin-left: 0;
                margin-top: 10px;
                width: auto !important;
            }
            .result-box {
                padding: 20px;
            }
            .result-box h2 {
                font-size: 1.5rem;
            }
            .result-box #resScore {
                font-size: 1.8em;
            }
            .result-box #resComment {
                font-size: 1rem;
                padding: 0;
            }
            .modal-content {
                padding: 20px;
            }
            .modal-content h3 {
                font-size: 1.3rem;
            }
            .modal-content #modalPoem {
                font-size: 1rem;
            }
            .close-btn {
                font-size: 26px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>🎯 詩物遊戲 AI 裁判</h1>
    
    <div class="status-bar">
        狀態：<span id="modeStatus" class="status-offline">等待 API Key</span>
    </div>

    <div class="settings">
        <div class="input-group">
            <label>🔑 Google Gemini API Key</label>
            <input type="password" id="apiKey" placeholder="請貼上您的 API Key">
            <button class="small-btn" onclick="loadModels()">🔄 載入可用模型</button>
            <div id="infoLog"></div>
        </div>
        
        <div class="input-group">
            <label>🤖 選擇 AI 模型</label>
            <select id="modelSelect" disabled>
                <option value="">請先載入模型列表</option>
            </select>
            <div class="model-info" id="modelInfo"></div>
        </div>
    </div>

    <div class="input-group">
        <label>1️⃣ 詩句編號 (1-80)</label>
        <input type="number" id="poemId" placeholder="例如：50">
        
        <div id="poem-preview-box">
            <div class="poem-header">
                <div class="poem-text" id="preview-text"></div>
                <button class="explain-btn" onclick="showExplanation(document.getElementById('poemId').value)">❓ 釋義</button>
            </div>
            <div class="poem-source" id="preview-source"></div>
        </div>
    </div>

    <div class="input-group">
        <label>2️⃣ 物理卡牌</label>
        <select id="physicsCard">
            <option value="光的反射">光的反射</option>
            <option value="光的折射">光的折射</option>
            <option value="光的直線傳播">光的直線傳播</option>
            <option value="光的色散">光的色散</option>
            <option value="分子擴散運動">分子擴散運動</option>
            <option value="分子運動論">分子運動論</option>
            <option value="物態變化">物態變化</option>
            <option value="熱傳遞">熱傳遞</option>  
            <option value="力的作用效果—形變">力的作用效果—形變</option>
            <option value="槓桿和力矩平衡原理">槓桿和力矩平衡原理</option>
            <option value="壓強">壓強</option>
            <option value="浮力">浮力</option>
            <option value="牛頓第一定律">牛頓第一定律</option>
            <option value="牛頓第二定律">牛頓第二定律</option>
            <option value="牛頓第三定律">牛頓第三定律</option>
            <option value="相對運動">相對運動</option>
            <option value="機械能守恆">機械能守恆</option> 
            <option value="自由落體運動">自由落體運動</option>
            <option value="位能和動能">位能和動能</option>
            <option value="機械振動">機械振動</option>
            <option value="曲線運動">曲線運動</option>
            <option value="動量守恆">動量守恆</option> 
            <option value="機械波">機械波</option>
            <option value="波的繞射">波的繞射</option>      
        </select>
    </div>

    <div class="input-group">
        <label>3️⃣ 解釋理由</label>
        <textarea id="explanation" rows="3" placeholder="請說明這張卡牌如何解釋詩句中的情境..."></textarea>
    </div>

    <button id="submitBtn" onclick="handleSubmit()" disabled>提交判定</button>

    <button id="gameEndBtn" onclick="showGameEndModal()">遊戲結束 記錄遊戲</button>



<div id="gameEndModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('gameEndModal').style.display='none'">&times;</span>
        <h3 id="gameEndTitle">遊戲結束 記錄成績</h3>
        <p style="text-align: center; color: var(--text-color-medium); font-size: 0.95rem; margin-bottom: 20px;">
            <strong style="color: var(--error-border);">※ 注意：</strong>檔案將下載到您的本地電腦。
        </p>
        
        <div class="player-inputs-grid">
            <div class="input-group">
                <label for="playerName1">玩家 1 名字</label>
                <input type="text" id="playerName1" placeholder="玩家 1" required>
            </div>
            <div class="input-group">
                <label for="cardsRemaining1">剩餘手牌 (1)</label>
                <input type="number" id="cardsRemaining1" min="0" value="0" required>
            </div>
            <div class="input-group">
                <label for="playerName2">玩家 2 名字</label>
                <input type="text" id="playerName2" placeholder="玩家 2" required>
            </div>
            <div class="input-group">
                <label for="cardsRemaining2">剩餘手牌 (2)</label>
                <input type="number" id="cardsRemaining2" min="0" value="0" required>
            </div>
            <div class="input-group">
                <label for="playerName3">玩家 3 名字</label>
                <input type="text" id="playerName3" placeholder="玩家 3" required>
            </div>
            <div class="input-group">
                <label for="cardsRemaining3">剩餘手牌 (3)</label>
                <input type="number" id="cardsRemaining3" min="0" value="0" required>
            </div>
            <div class="input-group">
                <label for="playerName4">玩家 4 名字</label>
                <input type="text" id="playerName4" placeholder="玩家 4" required>
            </div>
            <div class="input-group">
                <label for="cardsRemaining4">剩餘手牌 (4)</label>
                <input type="number" id="cardsRemaining4" min="0" value="0" required>
            </div>
            <div class="input-group">
                <label for="playerName5">玩家 5 名字</label>
                <input type="text" id="playerName5" placeholder="玩家 5" required>
            </div>
            <div class="input-group">
                <label for="cardsRemaining5">剩餘手牌 (5)</label>
                <input type="number" id="cardsRemaining5" min="0" value="0" required>
            </div>
            <div class="input-group">
                <label for="playerName6">玩家 6 名字</label>
                <input type="text" id="playerName6" placeholder="玩家 6" required>
            </div>
            <div class="input-group">
                <label for="cardsRemaining6">剩餘手牌 (6)</label>
                <input type="number" id="cardsRemaining6" min="0" value="0" required>
            </div>
            <div class="input-group">
                <label for="playerName7">玩家 7 名字</label>
                <input type="text" id="playerName7" placeholder="玩家 7" required>
            </div>
            <div class="input-group">
                <label for="cardsRemaining7">剩餘手牌 (7)</label>
                <input type="number" id="cardsRemaining7" min="0" value="0" required>
            </div>
            <div class="input-group">
                <label for="playerName8">玩家 8 名字</label>
                <input type="text" id="playerName8" placeholder="玩家 8" required>
            </div>
            <div class="input-group">
                <label for="cardsRemaining8">剩餘手牌 (8)</label>
                <input type="number" id="cardsRemaining8" min="0" value="0" required>
            </div>
        </div>
        
        <button id="recordScoreBtn" onclick="submitGameRecord()">提交記錄並生成 Excel 檔案</button>
    </div>
</div>
<div id="successModal" class="modal" style="display:none;">
    <div class="modal-content congratulations-content">
        <span class="close-btn" onclick="document.getElementById('successModal').style.display='none'; stopFireworks();">&times;</span>
        <h3 id="successTitle">🎉 遊戲結束 🎉</h3>
        
        <p id="summaryMessage">遊戲記錄已成功生成並下載！</p>
        <ul id="rankingList">
            </ul>
        
        <button onclick="document.getElementById('successModal').style.display='none'; stopFireworks();">確定</button>
    </div>
</div>
<div id="fireworks" class="fireworks-container" style="display:none;"></div>



    <div id="resultArea" class="result-box">
        <h2 id="resTitle" style="margin-top:0"></h2>
        <p id="resScore"></p>
        <p id="resComment"></p>
        <small id="resSource"></small>
    </div>

    <div id="errorLog"></div>

    <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #999;">
        💡 如遇到問題，請按 F12 開啟瀏覽器控制台查看詳細的 API 回應資訊
    </div>
</div>

<div id="explanationModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('explanationModal').style.display='none'">&times;</span>
        <h3 id="modalTitle">詩句釋義</h3>
        <p id="modalPoem"></p>
        <hr>
        <p id="modalExplanation"></p>
    </div>
</div>

<script>
    // ==========================================
    // 1. 詩詞資料庫 (完整版)
    // 這是詞解部分的數據核心，已包含語譯 (Explanation)
    // ==========================================
    const poemDB = {
        1: { text: "飛流直下三千尺", source: "李白《望廬山瀑布》" },
        2: { text: "朝辭白帝彩雲間，千里江陵一日還", source: "李白《早發白帝城》" },
        3: { text: "射人先射馬", source: "杜甫《前出塞》" },
        4: { text: "床前明月光，疑是地上霜", source: "李白《靜夜思》" },
        5: { text: "夜半鐘聲到客船", source: "張繼《楓橋夜泊》" },
        6: { text: "空山不見人，但聞人語響", source: "王維《鹿柴》" },
        7: { text: "橫看成嶺側成峰", source: "蘇軾《題西林壁》" },
        8: { text: "一道殘陽鋪水中，半江瑟瑟半江紅", source: "白居易《暮江吟》" },
        9: { text: "忽如一夜春風來，千樹萬樹梨花開", source: "岑參《白雪歌送武判官歸京》" },
        10: { text: "爐火照天地，紅星亂紫煙", source: "李白《秋浦歌》" },
        11: { text: "隨風潛入夜，潤物細無聲", source: "杜甫《春夜喜雨》" },
        12: { text: "欲窮千里目，更上一層樓", source: "王之渙《登鸛雀樓》" },
        13: { text: "不畏浮雲遮望眼", source: "王安石《登飛來峰》" },
        14: { text: "銀燭秋光冷畫屏", source: "杜牧《秋夕》" },
        15: { text: "餘音繞梁，三日不絕", source: "《列子·湯問》" },
        16: { text: "磨刀霍霍向豬羊", source: "《木蘭詩》" },
        17: { text: "風吹草低見牛羊", source: "《敕勒歌》" },
        18: { text: "沉舟側畔千帆過", source: "劉禹錫《酬樂天揚州初逢席上見贈》" },
        19: { text: "輕舟已過萬重山", source: "李白《早發白帝城》" },
        20: { text: "一江春水向東流", source: "李煜《虞美人》" },
        21: { text: "四兩撥千斤", source: "王宗岳《太極拳論》" },
        22: { text: "樹欲靜而風不止", source: "韓嬰《韓詩外傳》" },
        23: { text: "無邊落木蕭蕭下", source: "杜甫《登高》" },
        24: { text: "萬條垂下綠絲絛", source: "賀知章《詠柳》" },
        25: { text: "鐵騎突出刀槍鳴", source: "白居易《琵琶行》" },
        26: { text: "山回路轉不見君", source: "岑參《白雪歌送武判官歸京》" },
        27: { text: "疾風知勁草", source: "《後漢書》" },
        28: { text: "一道殘陽鋪水中", source: "白居易《暮江吟》" },
        29: { text: "掬水月在手", source: "于良史《春山夜月》" },
        30: { text: "潭清疑水淺", source: "儲光羲《釣魚灣》" },
        31: { text: "燈下草蟲鳴", source: "王維《秋夜獨坐》" },
        32: { text: "海上升明月", source: "張九齡《望月懷遠》" },
        33: { text: "天光雲影共徘徊", source: "朱熹《觀書有感》" },
        34: { text: "春江水暖鴨先知", source: "蘇軾《惠崇春江晚景》" },
        35: { text: "瀚海闌干百丈冰", source: "岑參《白雪歌送武判官歸京》" },
        36: { text: "鋤禾日當午", source: "李紳《憫農》" },
        37: { text: "炎炎日正午，灼灼火俱燃", source: "章應物《夏花明》" },
        38: { text: "朱門酒肉臭", source: "杜甫《自京赴奉先縣詠懷五百字》" },
        39: { text: "露從今夜白", source: "杜甫《月夜憶舍弟》" },
        40: { text: "暗香浮動月黃昏", source: "林逋《山園小梅》" },
        41: { text: "兩岸猿聲啼不住", source: "李白《早發白帝城》" },
        42: { text: "黃河之水天上來", source: "李白《將進酒》" },
        43: { text: "石破天驚逗秋雨", source: "李賀《李憑箜篌引》" },
        44: { text: "大珠小珠落玉盤", source: "白居易《琵琶行》" },
        45: { text: "波光粼粼", source: "（成語）" },
        46: { text: "浮雲蔽白日", source: "《古詩十九首》" },
        47: { text: "千尋鐵鎖沉江底", source: "劉禹錫《西塞山懷古》" },
        48: { text: "踏花歸去馬蹄香", source: "（畫院考題）" },
        49: { text: "玉不琢，不成器", source: "《禮記·學記》" },
        50: { text: "大漠孤煙直", source: "王維《使至塞上》" },
        51: { text: "飛鳥之景，未嘗動也", source: "《莊子·天下》" },
        52: { text: "沉舟側畔千帆過", source: "劉禹錫《酬樂天》" },
        53: { text: "樓臺倒影入池塘", source: "高駢《山亭夏日》" },
        54: { text: "浮光躍金，靜影沉璧", source: "范仲淹《岳陽樓記》" },
        55: { text: "日出江花紅勝火", source: "白居易《憶江南》" },
        56: { text: "誰家玉笛暗飛聲", source: "李白《春夜洛城聞笛》" },
        57: { text: "欲近曉天啼一聲", source: "崔道融《雞》" },
        58: { text: "向來枉費推移力，此日中流自在行", source: "朱熹《泛舟》" },
        59: { text: "水心如鏡面，千里無纖毫", source: "白居易《初領郡政衙退登東樓作》" },
        60: { text: "月上柳梢頭，人約黃昏後", source: "歐陽修《生查子·元夕》" },
        61: { text: "落霞與孤鶩齊飛，秋水共長天一色", source: "王勃《滕王閣序》" },
        62: { text: "水皆縹碧，千丈見底", source: "吳均《與朱元思書》" },
        63: { text: "零落成泥碾作塵，只有香如故", source: "陸游《卜算子·詠梅》" },
        64: { text: "水何澹澹，山島竦峙", source: "曹操《觀滄海》" },
        65: { text: "馬作的盧飛快", source: "辛棄疾《破陣子》" },
        66: { text: "水石相搏，聲如洪鐘", source: "蘇軾《石鐘山記》" },
        67: { text: "纖雲弄巧，飛星傳恨，銀漢迢迢暗度", source: "秦觀《鵲橋仙》" },
        68: { text: "解落三秋葉，能開二月花", source: "李嶠《風》" },
        69: { text: "亂石穿空，驚濤拍岸，捲起千堆雪", source: "蘇軾《念奴嬌·赤壁懷古》" },
        70: { text: "天街小雨潤如酥", source: "韓愈《早春呈水部張十八員外》" },
        71: { text: "銀燭吐清煙，金樽發香氣", source: "賈至《春夜別友人》" },
        72: { text: "誰家玉笛暗飛聲，散入春風滿洛城", source: "李白《春夜洛城聞笛》" },
        73: { text: "雷聲千嶂落，雨色萬峰來", source: "李攀龍《廣陽山道中》" },
        74: { text: "泉聲咽危石，日色冷青松", source: "王維《過香積寺》" },
        75: { text: "一夜雨聲涼到夢，萬荷葉上送秋來", source: "陳文述《夏日雜詩》" },
        76: { text: "潭中魚可百許頭，皆若空遊無所依", source: "柳宗元《小石潭記》" },
        77: { text: "空山新雨後，天氣晚來秋", source: "王維《山居秋暝》" },
        78: { text: "金就礪則利", source: "《荀子·勸學》" },
        79: { text: "黃河遠上白雲間", source: "王之渙《涼州詞》" },
        80: { text: "唧唧復唧唧", source: "《木蘭詩》" }
    };
    // ============== 新增的詞解資料庫 開始 ==============
    // D. 詩句解釋資料庫 (根據您提供的 PDF 內容提取前 25 條)
    const explanationDB = {
        1: "香爐峰在陽光的照耀下升騰起紫色的雲煙,遠遠望去,瀑布就像一條懸掛在山前的河流。那飛瀉而下的水流,筆直地奔流了三千尺之長,讓人懷疑那是不是銀河從九重天外傾瀉而下。",
        2: "清晨,我告別了高聳入雲、繚繞著五彩雲霞的白帝城;從這裡到千里之外的江陵,搭乘的船隻一天之內就能返回。兩岸猿猴的啼叫聲還在耳邊不斷回響,不知不覺中,輕快的小船已經駛過了層層疊疊的萬重山巒。",
        3: "拉弓應當拉最強勁的,用箭應當用最長的。要射人,最好先射他騎的馬;要擒拿賊寇,最好先擒獲他們的頭領。殺人也應該有個限度,每個國家都有自己的疆界。如果能夠有效地制止敵人的侵略,又何必在於過多地殺人呢?",
        4: "明亮的月光灑在床前的地面上,讓人懷疑是不是結了一層潔白的霜。我抬起頭來,凝望著天邊那輪皎潔的明月;低下頭時,思鄉之情油然而生。",
        5: "月亮已落下,烏鴉在啼叫,寒霜之氣瀰漫了整個夜空。面對著江邊的楓樹和點點漁火,我懷著愁緒難以入眠。就在這時,蘇州城外的寒山寺傳來了半夜的鐘聲,悠揚地飄到了我這艘客船上。",
        6: "幽靜的山谷裡看不見一個人影,只偶爾能聽到遠處傳來的人說話的聲音。夕陽的餘暉穿過茂密的樹林,又回照在翠綠的青苔之上。",
        7: "從正面看廬山,它是一道綿延的山嶺;從側面看,它又變成了一座高聳的山峰。隨著觀看距離的遠近和角度的高低變化,廬山呈現出各種不同的樣貌。我之所以無法認識廬山的真正面貌,只是因為我自己就身處在這座大山之中啊。",
        8: "一道傍晚的夕陽光芒鋪灑在江面上,使得江水一半呈現出碧綠的顏色,一半呈現出殷紅的顏色。最可愛的是這九月初三的夜晚,露水像珍珠一樣晶瑩,月亮像彎弓一樣皎潔。",
        9: "北風席捲大地,白草被吹得折斷,塞外的八月天就已經大雪紛飛。那雪花積在樹枝上,忽然間就像一夜春風吹來,成千上萬棵梨樹都開滿了潔白的花朵。雪花飄進珠簾,打濕了羅帳,穿著狐皮袍子也感覺不到溫暖,蓋著絲綢被子也覺得單薄。將軍的角弓凍得拉不開,都護的鐵甲冰冷得難以穿上。",
        10: "冶煉金屬的爐火熊熊燃燒,火光照亮了整個天地,通紅的火星在紫色的煙霧中四處飛濺。在明亮的月夜下,那些因爐火烘烤而臉色通紅的煉銅工人,他們高亢的歌聲在寒冷的河面上迴盪。",
        11: "這場好雨似乎知道時節的需要，正是在春天萬物萌發的時候降臨。它伴隨著和風在靜悄悄的夜晚潛入，細密地滋潤著萬物，卻沒有發出一點聲響。鄉間的小路和天空的烏雲一片漆黑，只有江上漁船的燈火獨自明亮。等到天亮時再去看那被雨水浸濕的地方，就會看到錦官城（成都）裡處處是帶著雨珠、嬌豔欲滴的繁花了。",
        12: "夕陽沿著西山慢慢落下，滔滔的黃河向著大海奔流而去。如果想要看到千里之外更遠的景物，就需要再登上更高的一層樓。",
        13: "飛來峰上聳立著千尋高的寶塔，聽說在塔上雞鳴時分就能看到旭日東升。我從不害怕那些飄浮的雲霧會遮擋住我遠望的視線，這自然是因為我已經身處在最高的地方。",
        14: "銀白色的蠟燭在秋夜裡發出清冷的光，照著冷清的畫屏；宮女手裡拿著輕巧的絲羅小扇，百無聊賴地撲打著飛來飛去的螢火蟲。宮殿台階上的夜色冰涼如水，她就這樣靜靜地坐著，仰望天上的牛郎星和織女星。",
        15: "從前，韓國有個名叫韓娥的女子要到東方的齊國去，途中粮食吃完了。路過雍門時，她便靠賣唱來換取食物。她離開之後，那歌聲的餘韻還在屋梁間繚繞，三天三夜都沒有消失，周圍的人還以為她沒有離開呢。",
        16: "父母聽說女兒回來了，互相攙扶著到城外去迎接。姐姐聽說妹妹回來了，對著門戶梳妝打扮。弟弟聽說姐姐回來了，正在霍霍地磨刀，準備宰殺豬羊（來慶祝）。（木蘭回家後）打開我東邊的房門，坐上我西邊的床榻。",
        17: "遼闊的敕勒大平原，就在陰山山腳下。天空就像一個巨大的圓頂帳篷，籠罩著四面八方的原野。天空是那樣的湛藍，原野是那樣的遼闊蒼茫。當風吹過，高高的牧草彎下腰去，成群的牛羊就顯現出來了。",
        18: "在巴山楚水這些淒涼的地方，我被貶謫棄置了二十三年。懷念舊友，只能像向秀那樣徒然吟誦《思舊賦》；回到家鄉，人事變遷，恍如隔世，自己反倒像那個爛了斧柄的王質。沉沒的船隻旁邊，有成千上萬的帆船駛過；枯萎的病樹前頭，有萬千樹木迎來春天，生機勃勃。今天聽了您為我唱的這首歌，姑且借這杯酒來振奮一下精神吧。",
        19: "清晨，我告別了高聳入雲、繚繞著五彩雲霞的白帝城；從這裡到千里之外的江陵，搭乘的船隻一天之內就能返回。兩岸猿猴的啼叫聲還在耳邊不斷回響,不知不覺中,輕快的小船已經駛過了層層疊疊的萬重山巒。",
        20: "這春花秋月的美景，什麼時候才能了結呢？過去的往事，又有誰能知道多少。昨夜小樓上又吹來了東風，在明亮的月光下，實在不忍心回頭望那破碎的故國。當年宮殿裡精雕細琢的欄杆和玉石台階應該還在，只是當年宮中人的容顏都已經改變了。如果要問我心中有多少哀愁？那正像一整條滔滔不絕的春江之水，奔騰著向東流去。",
        21: "（在太極拳的技中中）要著著對方的來力，使其落空，然後借力發勁。……考察「用四兩的微小力量就能撥動千斤的重物」這句話，就明白顯然不是憑藉蠻力取勝；觀察年邁的老者能夠抵禦眾多壯漢的情形，就知道光靠快是沒用的。",
        22: "（那人說：）「我年輕時喜歡學習，周遊列國，等我回來時，我的父母卻已經去世了，這是第一大過失；我侍奉的君主奢侈驕橫，我的勸諫他不聽從，這是第二大過失；我與朋友交情深厚，後來卻與他們斷絕了來往，這是第三大過失。樹想要靜止，風卻不停地吹動它；子女想要贍養父母，父母卻已經等不及去世了。過去了就再也追不回來的，是歲月；離開了就再也見不到的，是親人啊。」",
        23: "風刮得又急又猛，天空顯得格外高遠，猿猴的啼叫聲淒厲哀傷；江中小洲的沙灘潔白，水質清澈，鳥兒在空中盤旋迴盪。無邊無際的樹林裡，落葉正蕭蕭地飄落下來；望不盡的長江水，正波濤洶湧地滾滾而來。我常年漂泊在外，遠離家鄉萬里，在這悲涼的秋日裡作客；一生體弱多病，今天又獨自一人登上這高台。時世的艱難和個人的愁苦，讓我原本就花白的鬢髮增添了更多的白霜；窮困潦倒，最近因為生病，連借以銷愁的濁酒都不得不停掉了。",
        24: "高高的柳樹就像一位用碧玉裝扮而成的美人，千萬條柳枝垂掛下來，如同她身上綠色的絲帶。不知道這纖細的柳葉是誰裁剪出來的？原來那二月的春風，就像一把靈巧的剪刀啊。",
        25: "（那琵琶聲）時而高亢激越，就像銀瓶突然破碎，裡面的水漿四處迸射；又像鐵甲騎兵突然衝殺出來，刀槍碰撞發出鏗鏘的聲響。樂曲結束時，她用撥子在琵琶中心猛地一劃，四根弦同時發出的聲音，就像撕裂絲綢一樣尖銳。",
        26: "（我目送著你遠去），直到山路迴環、轉過山角，再也看不見你的身影，只看到雪地上空留下一串你馬蹄的印跡。",
        27: "光武帝劉秀對王霸說：「當初在潁川跟隨我的人都離開了，只有你一個人留下來繼續為我效力，真可以說是『在猛烈的風中才能看出哪種草是堅韌的』啊。」 ",
        28: "一道傍晚的夕陽光芒鋪灑在江面上，使得江水一半呈現出碧綠的顏色,一半呈現出殷紅的顏色。最可愛的是這九月初三的夜晚，露水像珍珠一樣晶瑩，月亮像彎弓一樣皎潔。 ",
        29: " （在春天的山中有很多美好的景致），我賞玩到深夜都忘記了回家。用手捧起一捧清泉，天上的月亮就倒映在我的手心裡；撥弄路邊的花朵，衣衫上便沾滿了芬芳的香氣。",
        30: "水潭是如此的清澈，以至於讓人懷疑它的水很淺；看到荷葉在晃動，就知道是有魚兒被驚動而散開了。天色已晚，我把船繫在綠楊樹下的岸邊，等待著我的心上人。\ ",
        31: "我獨自坐著，為自己日漸斑白的雙鬢而感到悲傷，空蕩蕩的廳堂裡，時間已將近二更。窗外，山中的野果在雨中不斷落下；燈下，草叢裡的秋蟲發出唧唧的鳴叫。頭上的白髮終究難以再變黑，煉丹求仙也終究不可能成功。想要知道如何擺脫衰老和疾病的煩惱，恐怕只有學習佛家「無生」的教義了。",
        32: "一輪皎潔的明月從遼闊的大海上升起，遠在天涯海角的我們，此刻正共同仰望著它。有情人埋怨這漫漫長夜，整夜無法入眠，起來排遣那無盡的相思之情。吹滅了蠟燭，更憐愛這滿屋的月光；披上外衣，才感覺到夜露已沾濕了衣裳。無法用手捧起這美好的月光送給你，只好回到床上，希望能與你在夢中相會。 ",
        33: "半畝見方的小池塘，像一面打開的鏡子，清澈明亮；天空的光彩和浮雲的影子，都在這水面上一起蕩漾徘徊。如果要問這池塘的水為何能如此清澈呢？那是因為有源源不斷的活水從源頭流進來啊。",
        34: "竹林外，有兩三枝桃花悄然綻放；春天江水的回暖，水中的鴨子是最先察覺到的。河灘上長滿了蔞蒿，蘆葦也剛冒出短短的新芽，這正是河豚將要逆流而上、最為肥美的時節。",
        35: "浩瀚的沙漠結了百丈厚的冰，縱橫交錯，布滿裂紋；憂愁的雲層慘白暗淡，凝結在萬里長空之上。\主帥在中軍帳中擺下酒宴，為歸去的客人（武判官）餞行，席間奏響了胡琴、琵琶和羌笛等邊塞樂器。",
        36: "農夫在正午的烈日下鋤地除草，汗水一滴滴地落在了禾苗下的土地裡。有誰知道，我們餐盤中的每一頓飯，每一粒米，都飽含著農夫們的辛勞和汗水啊。",
        37: "夏日景色宜人，我厭倦了待在房中，便移席到花叢中賞玩。正午的太陽火辣辣地照著，那盛開的鮮花（如石榴花）紅得像一團團燃燒的火焰。花朵在風中翻動，姿態錯落有致；倒映在水中，又顯得格外鮮豔。到了傍晚，花兒的景象又變得不同，在暮色中漸漸模糊，如同籠罩在煙霧之中。",
        38: "富貴人家的門內，酒肉多得吃不完而腐爛發臭；門外的道路上，卻有因飢寒交迫而凍死的窮人的屍骨。富貴與貧賤、生存與死亡，僅僅一牆之隔，卻是天壤之別，這種巨大的反差讓我內心充滿了無盡的惆悵，難以用語言再描述。 ",
        39: "戍樓上的鼓聲響起，宣告宵禁，路上的行人絕跡；邊塞的秋天，只聽到一聲孤雁的哀鳴。從今夜起，露水就因白露節氣的到來而顯得更重更白了；天上的月亮，總覺得還是故鄉的那一輪最為明亮。我有幾個弟弟，卻都各自流散東西；我沒有一個可以詢問他們是死是活的家。寄出去的書信常常無法送達，更何況戰亂還沒有平息呢。 ",
        40: "當百花都已凋零時，只有梅花依然美麗地綻放，獨佔了這小園裡所有的風光情致。它那稀疏的枝影橫向地斜映在清淺的水面上，一陣若有若無的清香在黃昏的月色下輕輕飄動。白色的水鳥想要飛下來棲息，會先偷偷地觀察它；蝴蝶如果知道梅花有如此的美態，一定會為之傾倒銷魂。慶幸我還能輕聲吟詠詩句來與你親近，完全不需要那些歌舞宴飲的喧囂。",
        41: "清晨，我告別了高聳入雲、繚繞著五彩雲霞的白帝城；從這裡到千里之外的江陵，搭乘的船隻一天之內就能返回。兩岸猿猴的啼叫聲還在耳邊不斷回響，不知不覺中，輕快的小船已經駛過了層層疊疊的萬重山巒。 ",
        42: "你沒看到嗎？那黃河的滔滔江水，像是從天上傾瀉而下，一路奔騰流入大海，再也不會回頭。你沒看到嗎？高堂之上的人們對著明亮的鏡子，為自己的白髮而悲傷，早晨還是一頭烏黑的青絲，到了傍晚就變成了雪白的頭髮。人生在世，得意之時就應當盡情歡樂，不要讓金杯空對著明月。上天既然生下了我這樣的人才，就必定有用武之地；千兩黃金即便散盡了，也還會再賺回來。 ",
        43: "（箜篌的聲音）時而像崑崙山的玉石被擊碎，又像鳳凰在鳴叫；時而像芙蓉花帶著露水在哭泣，又像蘭花含著芬芳在微笑。那清冷的樂音在長安城的十二座城門前融化流淌，二十三根琴弦彈奏出的音樂感動了天帝。樂聲的高亢，甚至能穿透女媧補天時留下的頑石，驚動上天，引來一場秋雨。聽著音樂，我彷彿在夢中進入神山，去教導神女彈琴，連年老的魚兒都興奮地躍出水面，瘦長的蛟龍也隨之起舞。",
        44: "時而嘈雜，時而細碎，各種音色交錯彈奏，那聲音就像大大小小的珍珠，一顆顆落在玉盤上，清脆悅耳。有時又像黃鶯在花叢底下婉轉啼叫，聲音流暢圓潤；有時又像泉水在冰層下流動，聲音嗚咽阻塞，艱澀難行。",
        45: "「波光粼粼」形容水面在陽光或月光的照射下，反射出閃爍的光芒，呈現出一片片細小而明亮的樣子。 ",
        46: "走啊走啊，不停地向前走，從此與你活生生地分離了。我們相隔萬里之遙，各自在天的一方。道路艱險而又漫長，我們何時才能再相見呢？北方的馬兒依戀北風，南方的鳥兒在朝南的樹枝上築巢。（連禽獸都思念故鄉，何況是人呢？）我們分別的日子越來越久，我的衣帶也因思念你而日漸消瘦，變得越來越寬鬆。就像浮雲遮蔽了太陽的光輝一樣，在外的遊子（你）也不顧念著回家。思念你使我容顏衰老，歲月流逝，轉眼間一年又要過去了。那些被拋棄的哀怨話語就不要再說了，還是請你努力多吃點飯，保重身體吧。",
        47: "當年王濬率領著高大的戰船從益州順流而下，金陵城（東吳國都）的帝王之氣便黯然消失了。東吳用來攔截晉軍的、長達千尋的鐵索，最終也沉入了江底；一片投降的白旗從石頭城裡升了起來。人生在世，有多少次會為過去的往事而傷感呢？眼前的西塞山，它的形勢依然不變，靜靜地枕在寒冷的江流之上。如今正逢天下統一、四海為家的太平盛世，當年戰爭的營壘故地，只剩下蕭瑟的蘆葦和荻花在秋風中搖曳。 ",
        48: "（騎馬的人）遊春歸來，馬蹄上彷彿還帶著一路踩過的百花的芬芳。 ",
        49: "一塊美玉如果不經過雕琢，就不能成為有用的器物；一個人如果不學習，就不會明白事理和道義。因此，古代的君王建立國家、治理人民，都是把教育放在首要的位置。 ",
        50: "我輕車簡從，要去邊境慰問將士，路途上經過了漢代屬國的居延地區。我就像飄飛的蓬草一樣離開了漢家的邊塞，看到歸去的大雁飛入塞外的天空。廣闊無垠的沙漠上，一縷烽火台的炊煙筆直地升向天空；綿長的黃河之上，一輪渾圓的落日正緩緩沉下。在蕭關附近，我遇到了前來迎接的偵察騎兵，他們告訴我，都護（主帥）正在燕然山前線。 ",
        51: "（公孫龍的學說中有一條是：）正在飛翔著的鳥兒，它的影子其實是從來沒有移動過的。 ",
        52: "此句以「沉舟」比喻過時的、被淘汰的事物或人（如詩人自己），以「千帆」比喻不斷湧現的新生力量。它表達了詩人雖然身處逆境，但依然能看到新陳代謝、時代前進的客觀規律，體現了其豁達樂觀的胸襟和對未來的信心。 ",
        53: "夏日的白天特別漫長，濃密的綠樹投下片片蔭涼，高高的樓臺清晰地倒映在池塘中。一陣微風輕輕吹起，（彷彿）水晶製成的簾子在微微晃動；滿架的薔薇花盛開，讓整個庭院都充滿了芬芳的香氣。",
        54: "至於到了春風和煦、陽光明媚的時候，湖面波平浪靜，天色與水光相接，一片碧綠，廣闊無垠；沙鷗時而飛翔，時而停歇，美麗的魚兒在水中游動；岸邊的香草和沙洲上的蘭花，香氣濃郁，一片青翠。有時，煙霧全部消散，皎潔的月光灑滿千里湖面，月光照在浮動的水波上，如同閃爍的黃金；月亮的倒影靜靜地沉在水底，就像一塊無瑕的美玉。漁夫的歌聲此起彼伏，這種快樂真是無窮無盡啊！ ",
        55: "江南的景色真是好，那裡的風景我過去太熟悉了。\太陽升起的時候，江邊的鮮花紅得比火焰還要豔麗；春天到來的時候，江水綠得像靛青染料一樣深邃。怎能叫我不思念江南呢？",
        56: "此句描寫在春天的夜晚，不知從誰家傳來了悠揚的笛聲。「玉笛」點明樂器之精美，也暗示聲音之清越。「暗飛聲」的「暗」字，寫出了笛聲在夜色中悄然傳來、不知其源的朦朧感；「飛」字則生動地描繪了聲音在空中傳播的動態。整句詩營造了一個靜謐而又富有動感的聽覺意境，引發了詩人由笛聲《折楊柳》而起的思鄉之情。 ",
        57: "我買來的這隻報曉的公雞，我常常跟它說話，（告訴它）平時不要隨便亂叫。只有在深山裡月黑風高、風雨交加的夜晚，在天快要亮的時候，它才會啼叫一聲（來報曉）。",
        58: "昨天夜裡，江邊的春水漲了起來，那平時沉重無比的艨艟巨艦，此刻也變得像一根羽毛一樣輕巧。過去（水淺時）白白浪費了那麼多力氣去推動它都紋絲不動，今天在江心主流之中，卻能自由自在地航行了。",
        59: "（處理完公務後）在樓上悠閒地看著遠山，山色青翠得彷彿要滴下來一樣。湖水（或江水）的中心平靜得像一面鏡子，廣闊的水面上連一絲一毫的波紋或雜物都沒有。",
        60: "去年的元宵節夜晚，花燈市場上燈火通明，亮如白晝。當月亮悄悄升上柳樹的梢頭，我與他（她）相約在黃昏之後見面。今年的元宵節夜晚，月色和燈光依然和去年一樣。卻再也見不到去年的那個人了，傷心的淚水沾濕了我的春衫衣袖。",
        61: "雨後的積水已經消盡，寒冷的潭水顯得格外清澈；傍晚的煙霧凝結不動，遠山呈現出紫色的輪廓。……絢麗的晚霞與孤單的野鴨一同在天空中飛翔，澄澈的秋水與蔚藍的長天融合成了一種顏色。傍晚時分，漁船上傳來悠揚的歌聲，響遍了整個鄱陽湖的岸邊；雁群因寒意而受驚，鳴叫聲消失在衡陽的南浦。 ",
        62: "風和煙霧都消散了，天空和遠山呈現出同樣的顏色。我乘著船隨著水流飄蕩，任憑它向東或向西。從富陽到桐廬這一百里左右的水路上，奇異的山峰和清澈的河水，真是天下獨一無二的絕景。這裡的水都是青綠色的，即使深達千丈也能看到水底。水中的游魚和細小的石子，都可以直接看到，沒有任何阻礙。 ",
        63: "在驛站外斷橋的旁邊，有一株梅花寂寞地開放，無人觀賞。天色已到黃昏，它獨自地在發愁，更何況還經受著風雨的吹打。它無意去和百花爭搶春光，任由那群芳去嫉妒。即使有一天它凋零了，被碾成了泥土和塵埃，但它那沁人的芬芳卻依然和從前一樣。",
        64: "向東登上碣石山，來觀看那浩瀚的大海。海水是多麼的波濤洶湧，海中的島嶼高高地聳立著。島上樹木叢生，各種草兒長得非常茂盛。蕭瑟的秋風吹來，巨大的波濤洶湧澎湃。太陽和月亮的運行，彷彿是從這大海中升起；璀璨的銀河星漢，彷彿也是出自這大海的懷抱。我真是幸運極了，可以用詩歌來詠唱我的志向。 ",
        65: "在醉意中，我挑亮油燈，欣賞著我的寶劍；從夢中醒來，只聽到軍營中號角聲此起彼伏。在軍中，士兵們分食著烤熟的牛肉，各種樂器奏響了雄壯的邊塞曲調。這是在秋天的沙場上檢閱軍隊。我騎的戰馬，像傳說中的的盧馬一樣飛速奔馳；我拉開的弓，發出的聲音像霹靂一樣，讓弓弦都為之震驚。我多麼希望能為君王完成統一天下的大業，從而贏得生前身後不朽的名聲。只可惜，如今理想尚未實現，白髮卻已經悄悄地長出來了！ ",
        66: "（蘇軾在探明石鐘山得名原因後，笑著對兒子蘇邁說：）「你明白了嗎？這鏗鏘的聲音，是水與石頭相互撞擊而發出的，聽起來就像巨大的鐘聲一樣。」 ",
        67: "天上的流雲變幻出巧妙的圖案，閃爍的流星彷彿在傳遞著離愁別恨，牛郎和織女在七夕之夜，悄悄地渡過那遙遠的銀河。他們在秋風白露之時的這一次相逢，就已經勝過了人間無數次朝夕相伴的俗情。那脈脈的柔情就像流水一樣綿長，這美好的會期卻像一場夢一樣短暫，怎忍心回頭看那鵲橋歸路呢？但如果兩個人之間的愛情是永恆而堅貞的，又何必在乎是不是每天都在一起呢？",
        68: "它（風）能夠讓深秋時節的樹葉凋零飄落，也能夠讓二月早春的花朵競相開放。它吹過江面時能掀起千尺高的巨浪，吹進竹林時能讓萬竿翠竹都為之傾斜。 ",
        69: "長江的水滾滾向東流去，波浪淘盡了千百年來的英雄人物。在那舊營壘的西邊，人們說那就是三國時周瑜大破曹軍的赤壁。這裡，陡峭的岩石直插雲霄，洶湧的波濤不斷拍打著江岸，激起的浪花就像千萬堆潔白的雪。江山如此秀美如畫，一時間湧現出了多少英雄豪傑啊。 ",
        70: "京城的大道上，一場細細的春雨 내리다，滋潤得如同酥油一般。遠遠看去，地面上彷彿有了一層淡淡的草色，但走近了卻又看不見了。這正是一年之中春天最美好的時光，它的美景絕對勝過了那種楊柳成蔭、飛絮滿城的暮春景象。",
        71: "邊塞的紫氣與天邊的白雲連成一片，青春歲月裡，只有明月相伴。銀色的蠟燭吐出縷縷輕煙，金色的酒杯中散發出陣陣酒香。（離別在即），山也為我悲傷，水也為我哭泣，這份離愁別恨實在是太多了。我勸你不要推辭這杯酒，春風正笑著迎接我們的到來（意指前途光明，或指應及時行樂）。",
        72: "是誰家的玉笛在黑夜中悄悄地吹奏？那悠揚的笛聲，隨著春風飄散，傳遍了整個洛陽城。在這春天的夜晚，從樂曲中我聽到了那首熟悉的《折楊柳》，又有哪個離鄉在外的人，能不因此而勾起對故鄉的思念之情呢？",
        73: "雷聲彷彿從千百座山巒上滾落下來，雨霧的顏色從成千上萬座山峰間瀰漫而來。山中的鳥兒還在雨中飛翔，遠處的人家卻看不清楚，彷彿門戶還未打開。",
        74: "不知道香積寺究竟在哪裡，只是沿著山路走了好幾里，已經進入了高聳入雲的山峰之中。這裡古木參天，沒有人走過的小徑；深山之中，不知從何處傳來了隱約的鐘聲。泉水流過高聳的岩石，發出的聲音像是嗚咽一般；太陽的光色灑在青松上，也顯得清冷。傍晚時分，我在空寂的潭水邊，用禪定降服了內心的種種慾念（毒龍）。",
        75: "整夜的雨聲，帶來了絲絲涼意，甚至滲透到了我的夢中；清晨醒來，看到那千萬片荷葉上的雨珠，彷彿是它們為我送來了秋天的消息。 ",
        76: "潭水中的魚大約有一百來頭，都像是在空中游動一樣，沒有任何憑藉和依靠。陽光直射下來，魚的影子都清晰地投射在水底的石頭上。牠們有時呆呆地一動不動，有時又突然向遠處游去，來來回回，速度極快。彷彿在與遊人一同嬉戲玩樂。 ",
        77: "一場新雨過後，空寂的山中顯得格外清新，傍晚時分，天氣也帶來了陣陣秋天的涼意。皎潔的月光透過松林灑下，清澈的泉水在山石上潺潺流淌。竹林中傳來喧鬧聲，原來是洗完衣服的女子們結伴歸來；水中的蓮葉晃動，原來是順流而下的漁船駛過。儘管春天的芳華可以隨意地消歇，但眼前這秋天的美景，也足以讓隱居的人留戀忘返了。",
        78: "所以，木材經過墨線的校正就能變得筆直，金屬（刀劍）靠近磨刀石去磨礪就能變得鋒利，君子廣泛地學習，並且每天多次反省自己，那麼他的智慧就會更加清明，行為也就不會有過錯了。 ",
        79: "遠遠望去，那黃河彷彿是從高入白雲的遠方流淌而來；在萬仞高山之中，坐落著一座孤零零的城關。何必用羌笛吹奏那哀怨的《折楊柳》曲調呢？因為春風是吹不到這遙遠的玉門關來的。",
        80: "嘆息聲一聲接著一聲，木蘭正對著門戶在織布。（可是）聽不到織布機的聲音，只聽到姑娘的嘆息聲。問姑娘在思念什麼，問姑娘在回憶什麼。（木蘭回答說：）「姑娘我並沒有思念什麼，也沒有回憶什麼。」（只是因為）昨天晚上看到了徵兵的文書，可汗在大規模地徵集士兵，一連十二卷的軍書上，每一卷都有我父親的名字。 ",
    };
    // ============== 新增的詞解資料庫 結束 ==============

    // ==========================================
    // 3. 遊戲結束及記錄功能 (修正/更新：增加排名邏輯)
    // ==========================================

    let fireworksInterval;
    
    /**
     * 顯示遊戲結束/記錄成績的彈出視窗
     */
    function showGameEndModal() {
        document.getElementById('gameEndModal').style.display = 'flex';
        // 清空所有 8 組輸入
        for (let i = 1; i <= 8; i++) {
            document.getElementById(`playerName${i}`).value = '';
            document.getElementById(`cardsRemaining${i}`).value = '0';
        }
    }

    /**
     * 提交遊戲記錄，生成並下載 CSV 文件
     */
    function submitGameRecord() {
        const records = [];
        let allValid = false;

        // 1. 收集並驗證數據
        for (let i = 1; i <= 8; i++) {
            const nameInput = document.getElementById(`playerName${i}`).value.trim();
            const cardsInput = document.getElementById(`cardsRemaining${i}`).value.trim();
            const cards = parseInt(cardsInput);

            // 如果名字和手牌數都是空/0，則跳過這個玩家 (假設未參與)
            if (!nameInput && (cardsInput === '' || cards === 0)) {
                continue;
            }

            // 檢查數據有效性
            if (!nameInput || isNaN(cards) || cards < 0) {
                alert(`請檢查玩家 ${i} 的輸入：名字不可為空，剩餘手牌需為非負數字。`);
                return; // 任何一個無效就停止
            }
            
            allValid = true; // 至少有一個有效記錄
            records.push({ name: nameInput, cards: cards });
        }
        
        if (!allValid) {
            alert("請至少輸入一組有效的玩家名字和剩餘手牌數量！");
            return;
        }

        // 2. 排序並計算排名
        // 排序規則：手牌數量由少到多
        const rankedRecords = records.sort((a, b) => a.cards - b.cards);
        
        // 賦予排名，考慮平手
        let currentRank = 1;
        for (let i = 0; i < rankedRecords.length; i++) {
            if (i > 0 && rankedRecords[i].cards > rankedRecords[i - 1].cards) {
                currentRank = i + 1; // 只有分數不同時，排名才增加
            }
            rankedRecords[i].rank = currentRank;
        }

        // 3. 準備 Excel/CSV 數據
        const now = new Date();
        const fileNameStamp = now.toISOString().replace(/[:\-.]/g, '').slice(0, 15); 
        const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
        const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
        const dateTimeString = now.toLocaleDateString('zh-TW', dateOptions) + ' ' + now.toLocaleTimeString('zh-TW', timeOptions);
        
        // CSV 內容 (使用 UTF-8 BOM \ufeff 確保 Excel 中文不亂碼)
        let csvContent = `遊戲時間,${dateTimeString}\n`;
        csvContent += "排名,玩家名字,剩餘手牌數量\n";

        rankedRecords.forEach(r => {
            // 名字用雙引號包住，避免名字中包含逗號造成錯誤
            csvContent += `${r.rank},"${r.name}",${r.cards}\n`;
        });
        
        // 4. 創建並觸發下載 (生成Excel文件)
        const fileName = `GameRecord_${fileNameStamp}.csv`;
        
        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
        const link = document.createElement("a");
        if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        } else {
            alert("您的瀏覽器不支援自動下載。");
            return;
        }

        // 5. 關閉輸入框並更新成功視窗
        document.getElementById('gameEndModal').style.display = 'none';

        // 6. 渲染排名列表
        renderRanking(rankedRecords);

        // 7. 彈出恭喜視窗並觸發煙花
        document.getElementById('successTitle').textContent = "🎉 遊戲記錄完成 🎉";
        document.getElementById('successModal').style.display = 'flex';
        triggerFireworks();
    }
    
    /**
     * 根據排名數據渲染 HTML 列表
     * @param {Array<{name: string, cards: number, rank: number}>} records - 已排好序的玩家記錄
     */
    function renderRanking(records) {
        const rankingListEl = document.getElementById('rankingList');
        const summaryMessageEl = document.getElementById('summaryMessage');
        rankingListEl.innerHTML = ''; // 清空舊內容
        
        let winnerName = records[0].name;
        let winnerCards = records[0].cards;
        let tiedWinners = records.filter(r => r.rank === 1).map(r => r.name);
        
        if (tiedWinners.length > 1) {
             summaryMessageEl.textContent = `恭喜 ${tiedWinners.join('、')} 平手獲勝！`;
        } else {
             summaryMessageEl.textContent = winnerCards === 0 
                                            ? `恭喜 ${winnerName} 以零手牌達成完全勝利！`
                                            : `恭喜 ${winnerName} 獲勝！`;
        }


        records.forEach(r => {
            const li = document.createElement('li');
            const rankText = r.rank === 1 && records.filter(x => x.rank === 1).length === 1 
                             ? '🏆 冠軍' 
                             : `No.${r.rank}`;
                             
            li.innerHTML = `
                <span class="rank-number">${rankText}</span>
                <span>${r.name}</span>
                <span class="cards-count">${r.cards} 張</span>
            `;
            rankingListEl.appendChild(li);
        });
    }
    
    // ==========================================
    // 4. 煙花動畫功能 (不變)
    // ==========================================
    
    /**
     * 觸發簡單的星星/煙花效果
     */
    function triggerFireworks() {
        const fwContainer = document.getElementById('fireworks');
        fwContainer.style.display = 'block';
        
        stopFireworks(); // 確保先停止舊的

        const createStar = () => {
            const star = document.createElement('div');
            star.className = 'star';
            
            star.style.left = Math.random() * 100 + 'vw';
            star.style.top = Math.random() * 90 + 'vh'; 
            
            const size = Math.random() * 5 + 3; 
            star.style.width = size + 'px';
            star.style.height = size + 'px';
            star.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 70%)`;

            star.style.position = 'fixed';
            star.style.borderRadius = '50%';
            star.style.opacity = '0';
            star.style.animation = `burst ${Math.random() * 1.5 + 1}s ease-out forwards`;
            
            fwContainer.appendChild(star);
            
            setTimeout(() => {
                star.remove();
            }, 3000);
        };

        if (!document.getElementById('burst-keyframes')) {
            const style = document.createElement('style');
            style.id = 'burst-keyframes';
            style.innerHTML = `
                @keyframes burst {
                    0% { opacity: 1; transform: scale(0.5) translateY(0); }
                    50% { opacity: 0.8; transform: scale(1.5) translateY(-50px); }
                    100% { opacity: 0; transform: scale(2.5) translateY(-100px); }
                }
            `;
            document.head.appendChild(style);
        }

        fireworksInterval = setInterval(createStar, 100); 
        
        setTimeout(stopFireworks, 5000);
    }
    
    /**
     * 停止煙花效果
     */
    function stopFireworks() {
        clearInterval(fireworksInterval);
        document.getElementById('fireworks').style.display = 'none';
        document.getElementById('fireworks').innerHTML = ''; 
    }


    // ==========================================
    // 2. 詞解相關的 DOM 元素和邏輯
    // ==========================================
    const poemIdInput = document.getElementById('poemId');

    /**
     * 根據輸入的詩句 ID 更新預覽區內容
     * @param {string} idString - 詩句編號
     */
        const poemInput = document.getElementById('poemId');
        const previewBox = document.getElementById('poem-preview-box');
        const previewText = document.getElementById('preview-text');
        const previewSource = document.getElementById('preview-source');
      ////////  
         // 用於儲存當前選中的詩句內容，供 AI 使用
    let currentPoemData = null;

    poemInput.addEventListener('input', function() {
        const id = this.value.trim();
        
        // 清空狀態
        previewBox.classList.remove('error');
        currentPoemData = null;

        if (id === "") {
            previewBox.style.display = 'none';
            return;
        }

        const poem = poemDB[id];

        if (poem) {
            // 找到了：顯示內容
            currentPoemData = poem; // 存下來給 AI 用
            previewText.textContent = poem.text;
            previewSource.textContent = "—— " + poem.source;
            previewBox.style.display = 'block';
        } else {
            // 沒找到：顯示錯誤
            previewText.textContent = "⚠️ 找不到此編號的詩句";
            previewSource.textContent = "";
            previewBox.classList.add('error');
            previewBox.style.display = 'block';
        }
    });

    /**
     * 顯示詩句的完整釋義（詞解）彈出視窗
     * @param {string} idString - 詩句編號
     */
    function showExplanation(idString) {
        const id = parseInt(idString);
        const modal = document.getElementById('explanationModal');
        const modalPoem = document.getElementById('modalPoem');
        const modalExplanation = document.getElementById('modalExplanation');
        
        const poem = poemDB[id];

        if (poem) {
            modalPoem.textContent = poem.text;
            modalExplanation.innerHTML = `**【出處】** ${poem.source}<br><br>**【語譯】** ${poem.explanation}`;
            modal.style.display = 'flex'; // 使用 flexbox 居中
        } else {
            alert("找不到編號 " + id + " 的詩句釋義。請確認編號正確或資料庫已更新。");
        }
    }

    // 當輸入框內容改變時，更新預覽
    poemIdInput.addEventListener('input', (event) => {
        updatePoemPreview(event.target.value);
    });

    // ==========================================
    // 3. AI 判斷的核心邏輯 (與上一個版本相同，保持功能完整)
    // ==========================================
let availableModels = [];

    window.onload = function() {
        const savedKey = localStorage.getItem('gemini_key');
        if(savedKey) {
            document.getElementById('apiKey').value = savedKey;
            loadModels();
        }
    };

    async function loadModels() {
        const key = document.getElementById('apiKey').value.trim();
        const infoLog = document.getElementById('infoLog');
        const errorLog = document.getElementById('errorLog');
        const statusEl = document.getElementById('modeStatus');
        const modelSelect = document.getElementById('modelSelect');
        const submitBtn = document.getElementById('submitBtn');

        if(!key) {
            alert("請先輸入 API Key！");
            return;
        }

        localStorage.setItem('gemini_key', key);

        statusEl.textContent = "🔄 正在查詢可用模型...";
        statusEl.className = "status-loading";
        infoLog.style.display = 'block';
        infoLog.textContent = "正在連接 Google AI API...";
        errorLog.style.display = 'none';
        modelSelect.disabled = true;
        submitBtn.disabled = true;

        try {
            // [修改] 改用我們自己的 API Proxy，並傳遞原本的路徑參數
            const url = `/api/proxy?path=v1/models&key=${key}`;
            const response = await fetch(url);

            if (!response.ok) {
                const errorText = await response.text();
                let errorData;
                try { errorData = JSON.parse(errorText); } catch { throw new Error(`HTTP ${response.status}: ${errorText}`); }
                throw new Error(`${errorData.error?.message || '無法連接 API'}`);
            }

            const data = await response.json();

            if (!data.models || data.models.length === 0) throw new Error("未找到任何可用模型");

            availableModels = data.models.filter(model => 
                model.supportedGenerationMethods && 
                model.supportedGenerationMethods.includes('generateContent')
            );

            if (availableModels.length === 0) throw new Error("沒有支援文字生成的模型");

            const sortedModels = availableModels.sort((a, b) => {
                const nameA = a.name.toLowerCase();
                const nameB = b.name.toLowerCase();
                const getPriority = (name) => {
                    if (name.includes('flash-latest') || name.includes('1.5-flash')) return 1;
                    if (name.includes('flash')) return 2;
                    if (name.includes('pro')) return 3;
                    if (name.includes('2.5')) return 10;
                    return 5;
                };
                return getPriority(nameA) - getPriority(nameB);
            });

            modelSelect.innerHTML = '';
            let firstSelected = false;
            
            sortedModels.forEach((model) => {
                const option = document.createElement('option');
                option.value = model.name;
                const shortName = model.name.replace('models/', '');
                let label = shortName;
                if (shortName.includes('flash') && !shortName.includes('2.5')) label += ' ⭐️ (推薦)';
                else if (shortName.includes('2.5')) label += ' ⚠️ (可能不穩定)';
                
                option.textContent = label;
                if (!firstSelected && shortName.includes('flash') && !shortName.includes('2.5')) {
                    option.selected = true;
                    firstSelected = true;
                }
                modelSelect.appendChild(option);
            });

            statusEl.textContent = `✅ 已載入 ${availableModels.length} 個模型`;
            statusEl.className = "status-online";
            infoLog.textContent = `✅ 成功載入 ${availableModels.length} 個可用模型\n⭐️ 推薦使用 Flash 系列模型以獲得最佳速度與穩定性`;
            
            modelSelect.disabled = false;
            submitBtn.disabled = false;
            updateModelInfo();

        } catch (error) {
            console.error(error);
            statusEl.textContent = "❌ 載入失敗";
            statusEl.className = "status-offline";
            errorLog.style.display = 'block';
            infoLog.style.display = 'none';
            errorLog.textContent = `❌ 錯誤：${error.message}`;
        }
    }

    function updateModelInfo() {
        const modelSelect = document.getElementById('modelSelect');
        const modelInfo = document.getElementById('modelInfo');
        if (!modelSelect.value || availableModels.length === 0) {
            modelInfo.textContent = '';
            return;
        }
        const selectedModel = availableModels.find(m => m.name === modelSelect.value);
        if (selectedModel) {
            const shortName = selectedModel.name.replace('models/', '');
            let desc = selectedModel.displayName || shortName;
            modelInfo.textContent = `📋 ${desc}`;
        }
    }

    async function handleSubmit() {
        const key = document.getElementById('apiKey').value.trim();
        const modelName = document.getElementById('modelSelect').value;
        const poemId = document.getElementById('poemId').value;
        const card = document.getElementById('physicsCard').value;
        const exp = document.getElementById('explanation').value.trim();
        const btn = document.getElementById('submitBtn');
        const errorLog = document.getElementById('errorLog');

        if(!key) { alert("請先輸入 API Key！"); return; }
        if(!modelName) { alert("請先載入並選擇模型！"); return; }
        if(!poemId) { alert("請輸入詩句編號！"); return; }

        btn.disabled = true;
        btn.textContent = `🤖 AI 判定中...`;
        document.getElementById('resultArea').style.display = 'none';
        errorLog.style.display = 'none';

        try {
            // 準備詩句內容，如果資料庫有，直接傳文字給 AI，這樣 AI 更準確
            let poemContentForAI = `編號 ${poemId}`;
            if (currentPoemData) {
                poemContentForAI = `"${currentPoemData.text}" (${currentPoemData.source})`;
            }

            await callGeminiAI(key, modelName, poemContentForAI, card, exp);
        } catch (e) {
            console.error("❌ 完整錯誤:", e);
            errorLog.style.display = 'block';
            errorLog.textContent = `❌ 錯誤：${e.message}\n\n💡 建議：請嘗試切換其他模型 (推薦 gemini-1.5-flash)`;
        }

        btn.disabled = false;
        btn.textContent = "提交判定";
    }

    async function callGeminiAI(key, modelName, poemContent, card, exp) {
        // [修改] 這裡原本有 https:/// 的錯誤，現在修正並改用 API Proxy
        const url = `/api/proxy?path=v1/${modelName}:generateContent&key=${key}`;
        
        // 提示詞優化：直接使用詩句文字
        const prompt = `你現在是「詩物遊戲」的嚴格裁判。請根據以下資訊進行評判：
                
                【輸入資訊】
                詩句內容：${poemContent}
                物理卡牌：${card}
                學生解釋：${exp}

                【評判三大鐵律 (適中標準)】
                請依序檢查以下三點。違反第 1 或第 2 點直接判定不通過；第 3 點採取「邏輯關聯」判定：

                1. **關聯性檢查 (Relevance) - [嚴格]**：
                - 檢查玩家的解釋內容是否真的在描述「${card}」的物理機制。
                - 若卡片是 A，解釋卻在講 B，視為失敗。

                2. **完整性檢查 (Completeness) - [嚴格]**：
                - 解釋必須是完整的句子，且長度適中。
                - 若字數少於 8 個字，或只是破碎的關鍵字堆砌，視為失敗。
                - 評語請加上：「請使用完整語句說明，避免過短」。

                3. **情境結合 (Context Connection) - [適中標準]**：
                - **判定核心**：解釋不能只背誦物理定義，必須建立「物理原理」與「詩句元素」的**因果或邏輯關聯**。
                - **通過標準 (Pass)**：
                    即使沒有完整描述整首詩的情境故事，只要學生能明確指出物理原理**作用在詩中的哪個具體物體或現象上**，即可通過。
                    - *通過範例*：「水面像鏡子一樣反射了光線」（有指出物理原理如何作用於元素）。
                - **失敗標準 (Fail)**：
                    若解釋僅是物理定義，結尾隨便加上一個詩句名詞，卻**未解釋兩者關係**，視為失敗。
                    - *失敗範例*：「反射就是光遇到障礙物彈回。例如水。」（這只是關鍵字拼湊，沒有邏輯連結，判定不通過）。
                - 評語建議：若不通過，請提示：「請說明物理原理是如何作用在詩句中的物體上」。

                【輸出格式】
                請只回傳純 JSON 格式，不要有 Markdown 標記：
                {
                    "pass": boolean,
                    "score": integer (0-100),
                    "comment": "針對上述三大鐵律的具體評語 (繁體中文)"
                }
                    `;

        const requestBody = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.7, maxOutputTokens: 500 }
        };

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API 請求失敗: ${errorText}`);
        }

        const data = await response.json();
        
        if (!data.candidates || data.candidates.length === 0) {
            throw new Error("AI 無回應（可能被內容篩選器阻擋）");
        }

        const candidate = data.candidates[0];
        let text = candidate.content?.parts?.[0]?.text || candidate.text || candidate.output || "";
        
        if (!text) throw new Error("無法從 API 回應中提取文字");

        // 清理 Markdown
        text = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) text = jsonMatch[0];
        
        try {
            const result = JSON.parse(text);
            showResult(result.pass, result.score, result.comment, modelName.replace('models/', ''));
        } catch (parseError) {
            throw new Error(`無法解析 AI 回應為 JSON: ${text}`);
        }
    }

    function showResult(pass, score, comment, modelName) {
        const box = document.getElementById('resultArea');
        const title = document.getElementById('resTitle');
        const scoreEl = document.getElementById('resScore');
        const commentEl = document.getElementById('resComment');
        const sourceEl = document.getElementById('resSource');

        box.style.display = 'block';
        box.className = 'result-box ' + (pass ? 'pass' : 'fail');
        
        title.textContent = pass ? "🎉 判定通過" : "❌ 判定不通過";
        scoreEl.textContent = `得分：${score} 分`;
        commentEl.textContent = comment;
        sourceEl.textContent = `AI 裁判：${modelName}`;
    }

    document.getElementById('modelSelect').addEventListener('change', updateModelInfo);

    // 初始化時綁定事件
    document.addEventListener('DOMContentLoaded', () => {
        // 確保在頁面加載後，輸入框值變化時能觸發預覽更新
        updatePoemPreview(poemIdInput.value);
    });


    // ============== 新增的詞解函數 開始 ==============
    // E. 顯示解釋的彈出視窗函數 (加在所有其他函數之後)
    function showExplanation(cardId) {
        const id = parseInt(cardId, 10);
        const modal = document.getElementById('explanationModal');
        const titleEl = document.getElementById('modalTitle');
        const poemEl = document.getElementById('modalPoem');
        const expEl = document.getElementById('modalExplanation');
        
        if (poemDB[id] && explanationDB[id]) {
            titleEl.textContent = `卡號 ${id}：詩句釋義`;
            poemEl.textContent = `「${poemDB[id].text}」`;
            
            // 獲取解釋內容
            expEl.innerHTML = explanationDB[id];
            
            modal.style.display = 'block';
        } else if (poemDB[id]) {
            alert(`卡號 ${id} 找到詩句，但缺少詳細解釋。`);
        } else {
            alert('請先輸入有效的問題卡編號。');
        }

        // 點擊 Modal 外部關閉視窗
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    }
    // ============== 新增的詞解函數 結束 ==============
    
</script>
</body>
</html>